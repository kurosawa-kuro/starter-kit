# Hello World API - Makefile

.PHONY: help build run test clean deps

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "ğŸš€ Hello World API - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo ""
	@echo "  make build    - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make run      - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ"
	@echo "  make test     - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆDBãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯è‡ªå‹•èµ·å‹•ï¼‰"
	@echo "  make test-only - ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆDBã®èµ·å‹•ãƒ»åœæ­¢ãªã—ï¼‰"
	@echo "  make test-coverage - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãï¼‰"
	@echo "  make test-coverage-report - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
	@echo "  make test-coverage-html - HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
	@echo "  make test-setup - ãƒ†ã‚¹ãƒˆç”¨DBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåˆå›ã®ã¿å®Ÿè¡Œï¼‰"
	@echo "  make test-db-status - ãƒ†ã‚¹ãƒˆç”¨DBã®çŠ¶æ…‹ç¢ºèª"
	@echo "  make test-db-up   - ãƒ†ã‚¹ãƒˆç”¨DBã‚’èµ·å‹•"
	@echo "  make test-db-down - ãƒ†ã‚¹ãƒˆç”¨DBã‚’åœæ­¢"
	@echo "  make clean    - ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³"
	@echo "  make deps     - ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
	@echo "  make swagger  - Swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ"
	@echo "  make docker   - Docker Composeã§èµ·å‹•"
	@echo ""
	@echo "ç’°å¢ƒå¤‰æ•°ç®¡ç†:"
	@echo "  make env-init ENV=development # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–"
	@echo "  make env-validate # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼"
	@echo "  make env-backup # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"
	@echo "  make env-restore FILE=backup # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ"
	@echo "  make env-list # åˆ©ç”¨å¯èƒ½ãªç’°å¢ƒã‚’ä¸€è¦§è¡¨ç¤º"
	@echo ""
	@echo "  make help     - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
build:
	@echo "ğŸ”¨ Hello World API ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	cd src && go build -o ../bin/hello-world-api main.go
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†: bin/hello-world-api"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
run:
	@echo "ğŸš€ Hello World API ã‚’èµ·å‹•ä¸­..."
	cd src && go run main.go

# ãƒ†ã‚¹ãƒˆç”¨DBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåˆå›ã®ã¿å®Ÿè¡Œï¼‰
test-setup:
	@echo "ğŸ”§ ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."
	@./script/gen-test-env.sh
	@echo "ğŸ”§ ãƒ†ã‚¹ãƒˆç”¨DBã‚’èµ·å‹•ä¸­..."
	@docker compose -f docker/docker-compose.test.yml up -d db-test
	@echo "â³ DBèµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
	@sleep 10
	@echo "âœ… ãƒ†ã‚¹ãƒˆç”¨DBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

# ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆDBãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯è‡ªå‹•èµ·å‹•ï¼‰
test:
	@echo "ğŸ§ª Docker DBã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "ğŸ”§ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™..."; \
		$(MAKE) test-setup; \
	fi
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@cd src && GIN_MODE=test go test -v ./test/... -timeout 60s

# ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆDBã®èµ·å‹•ãƒ»åœæ­¢ãªã—ï¼‰
test-only:
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œä¸­ï¼ˆDBã®èµ·å‹•ãƒ»åœæ­¢ãªã—ï¼‰..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && GIN_MODE=test go test -v ./test/... -timeout 60s

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãï¼‰
test-coverage:
	@echo "ğŸ§ª ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && GIN_MODE=test go test -v -cover ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼‰
test-coverage-report:
	@echo "ğŸ§ª ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && GIN_MODE=test go test -v -coverprofile=../coverage.out ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: coverage.out"
	@echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°ã‚’è¡¨ç¤º:"
	@cd src && go tool cover -func=../coverage.out

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’HTMLã§è¡¨ç¤º
test-coverage-html:
	@echo "ğŸ§ª HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
	@if ! docker compose -f docker/docker-compose.test.yml ps db-test | grep -q "Up"; then \
		echo "âŒ ãƒ†ã‚¹ãƒˆç”¨DBãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã« make test-setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@cd src && GIN_MODE=test go test -v -coverprofile=../coverage.out ./services ./models ./handler ./middleware ./router ./config ./utils -timeout 60s
	@echo "ğŸ“Š HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
	@cd src && go tool cover -html=../coverage.out -o ../coverage.html
	@echo "âœ… HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: coverage.html"
	@echo "ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã: open coverage.html ã¾ãŸã¯ coverage.html ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯"

# ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³
clean:
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ä¸­..."
	rm -rf bin/
	rm -f coverage.out coverage.html
	go clean
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³å®Œäº†"

# ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°
deps:
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
	go mod tidy
	go mod download
	@echo "âœ… ä¾å­˜é–¢ä¿‚æ›´æ–°å®Œäº†"

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†
env-init:
	@echo "ğŸ”§ ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–ä¸­..."
	@if [ -z "$(ENV)" ]; then \
		echo "âš ï¸  ç’°å¢ƒã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®šã—ã¦ãã ã•ã„: make env-init ENV=development"; \
		echo "åˆ©ç”¨å¯èƒ½ãªç’°å¢ƒ: development, test, production"; \
		exit 1; \
	fi
	@./script/env-manager.sh init $(ENV)

env-validate:
	@echo "ğŸ” ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ä¸­..."
	@./script/env-manager.sh validate

env-backup:
	@echo "ğŸ’¾ ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
	@./script/env-manager.sh backup

env-restore:
	@echo "ğŸ”„ ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒä¸­..."
	@if [ -z "$(FILE)" ]; then \
		echo "âš ï¸  å¾©å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„: make env-restore FILE=.env.backup.20240101_120000"; \
		exit 1; \
	fi
	@./script/env-manager.sh restore $(FILE)

env-list:
	@echo "ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªç’°å¢ƒã‚’ä¸€è¦§è¡¨ç¤ºä¸­..."
	@./script/env-manager.sh list

# é–‹ç™ºç”¨ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
dev:
	@echo "ğŸ”¥ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "âš ï¸  air ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™ã€‚"; \
		go run main.go; \
	fi

# æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰
build-prod:
	@echo "ğŸ­ æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰ä¸­..."
	cd src && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o ../bin/hello-world-api main.go
	@echo "âœ… æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰å®Œäº†: bin/hello-world-api"

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
fmt:
	@echo "ğŸ¨ ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
	go fmt ./...
	@echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

# ãƒªãƒ³ãƒˆ
lint:
	@echo "ğŸ” ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ãƒˆä¸­..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"; \
	fi

# Swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
swagger:
	@echo "ğŸ“– Swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­..."
	@if command -v swag > /dev/null; then \
		cd src && swag init -g main.go; \
	else \
		echo "âš ï¸  swag ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚go install github.com/swaggo/swag/cmd/swag@latest ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
	fi

# Swaggerãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
test-swagger:
	@echo "ğŸ§ª Swaggerãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	go test -v ./test/... -run "TestSwagger"

# ãƒ†ã‚¹ãƒˆç”¨DBã‚’èµ·å‹•
test-db-up:
	@echo "ğŸ³ ãƒ†ã‚¹ãƒˆç”¨DBã‚’èµ·å‹•ä¸­..."
	docker compose -f docker/docker-compose.test.yml up -d db-test

# ãƒ†ã‚¹ãƒˆç”¨DBã®çŠ¶æ…‹ç¢ºèª
test-db-status:
	@echo "ğŸ” ãƒ†ã‚¹ãƒˆç”¨DBã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
	@docker compose -f docker/docker-compose.test.yml ps db-test

# ãƒ†ã‚¹ãƒˆç”¨DBã‚’åœæ­¢
test-db-down:
	@echo "ğŸ³ ãƒ†ã‚¹ãƒˆç”¨DBã‚’åœæ­¢ä¸­..."
	docker compose -f docker/docker-compose.test.yml down

# Docker Composeã§èµ·å‹•
docker:
	@echo "ğŸ³ Docker Composeã§èµ·å‹•ä¸­..."
	docker compose -f docker/docker-compose.yml up --build

# Docker Composeã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰èµ·å‹•
docker-bg:
	@echo "ğŸ³ Docker Composeã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰èµ·å‹•ä¸­..."
	docker compose -f docker/docker-compose.yml up -d --build

# Docker Composeã§åœæ­¢
docker-down:
	@echo "ğŸ³ Docker Composeã§åœæ­¢ä¸­..."
	docker compose -f docker/docker-compose.yml down
